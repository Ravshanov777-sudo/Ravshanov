import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from compiler import compile_code
from editor import CodeEditor

# Log konfiguratsiyasi
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Global o'zgaruvchilar
user_sessions = {}  # Foydalanuvchi sessiyalari

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Start komandasi"""
    user = update.effective_user
    welcome_text = f"""
ğŸš€ *CodeLab - Telegramdagi Replit!*

*Assalomu alaykum {user.first_name}!* ğŸ‘¨â€ğŸ’»

Bu bot orqali siz:
â€¢ ğŸ“ **Kod yozishingiz** mumkin
â€¢ â–¶ï¸ **Kodni ishga tushirishingiz** mumkin
â€¢ ğŸ“š **30+ darsliklar** orqali o'rganishingiz mumkin
â€¢ ğŸ¯ **Masalalarni** yechishingiz mumkin
â€¢ ğŸ’¾ **Loyihalaringizni** saqlab qo'yishingiz mumkin

*Tillar qo'llab-quvvatlanadi:*
âœ… Python 3.x
âœ… JavaScript (Node.js)
âœ… HTML/CSS
âœ… SQL

*Boshlash uchun:* /editor yoki /code
"""
    
    keyboard = [
        [InlineKeyboardButton("ğŸ“ Kod Yozish", callback_data="start_editor")],
        [InlineKeyboardButton("ğŸ“š Darsliklar", callback_data="lessons")],
        [InlineKeyboardButton("ğŸ¯ Masalalar", callback_data="challenges")],
        [InlineKeyboardButton("ğŸ“‚ Mening Loyihalarim", callback_data="my_projects")]
    ]
    
    await update.message.reply_text(
        welcome_text,
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def code_editor_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Kod editorini ochish"""
    user_id = update.effective_user.id
    
    # Yangi editor sessiyasi
    user_sessions[user_id] = {
        'editor': CodeEditor(),
        'current_file': 'main.py',
        'language': 'python'
    }
    
    keyboard = [
        [InlineKeyboardButton("ğŸ Python", callback_data="lang_python"),
         InlineKeyboardButton("â˜• JavaScript", callback_data="lang_js")],
        [InlineKeyboardButton("ğŸŒ HTML", callback_data="lang_html"),
         InlineKeyboardButton("ğŸ—ƒ SQL", callback_data="lang_sql")],
        [InlineKeyboardButton("ğŸ“‚ Fayl nomi", callback_data="change_filename"),
         InlineKeyboardButton("ğŸ’¾ Saqlash", callback_data="save_file")],
        [InlineKeyboardButton("â–¶ï¸ Ishga tushirish", callback_data="run_code"),
         InlineKeyboardButton("ğŸ§¹ Tozalash", callback_data="clear_code")]
    ]
    
    editor_text = """
ğŸ“ *Kod Editori*

*Fayl:* `main.py`
*Til:* Python

Kodingizni shu yerga yozing va â–¶ï¸ Ishga tushirish tugmasini bosing.

*Namuna kod:*
```python
print("Salom Dunyo!")
for i in range(5):
    print(f"Qadam: {i}")